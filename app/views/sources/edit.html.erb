<% content_for :head do %>
<%= stylesheet_link_tag "extras", media: "all" %>
<% end %>

<% if @source.persisted? %>
    <% @page_title = "Edit #{@source.public_id} - " + application_name %>
<% else %>
    <% @page_title = "Create new source - " + application_name %>
<% end %>

<% if @source.persisted? %>
<input type="hidden" id="source_id" value="<%= @source.id %>" />
<% end %>
<% if !params[:create_entry].nil? %>
<input type="hidden" id="create_entry" value="1" />
<% end %>

<form id="source-form" name="form" class="form-horizontal sdbmss-form" autocomplete="off" ng-controller="SourceCtrl" novalidate data-ng-cloak>

    <div class="row">
        <div class="col-sm-12 text-center">
            <legend>{{ getPageTitle() }}</legend>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <div ng-show="!source.source_type.name">
                <p>A source is the origin of information for an entry. Sources can include auction and sale catalogs, collection catalogues, published or unpublished inventories, censuses, an individual (you or someone else) who has made direct observations about a manuscript(s), etc. From the dropdown menu, select one of six Source Types (see definitions below) that best describes your source.</p>
            </div>
            <div ng-show="source.source_type.name">
                <p ng-show="source.source_type.name == 'auction_catalog'">Use this type for auction or sale catalogs for a specific sale event. For online-only auctions (such as eBay) or sale events, use the SOURCE TYPE: Online-only Auction or Bookseller Website.</p>
                <p ng-show="source.source_type.name == 'collection_catalog'">Use this type for published catalogs of institutional or private individual collections. For individuals, use SDBM PERSONAL NAME STANDARDS.</p>
                <p ng-show="source.source_type.name == 'online'">Use this type for online-only auctions, such as eBay, or for bookseller websites providing non-dated sale lists. This field is intended for information found only online and not referring to a specific, dated sale.</p>
                <p ng-show="source.source_type.name == 'observation'">Use this type when recording data acquired via direct personal observation of a manuscript.</p>
                <p ng-show="source.source_type.name == 'other_published'">Use this type for any other published source not applicable to the previous SOURCE TYPES (e.g., an inventory published in a journal article).</p>
                <p ng-show="source.source_type.name == 'unpublished'">Use for any unpublished data sources (e.g. in-house finding aid or inventory). When recording names of individuals, use SDBM PERSONAL NAME STANDARDS.</p>
                <p>Complete as many fields as possible to create the source. No fields are mandatory.</p>
            </div>
        </div>
    </div>

    <div class="form-group row">
        <label for="source_type" class="col-sm-2 control-label"><span sdbm-tooltip="source_type">Source Type</span></label>
        <div class="col-sm-4">
            <select class="form-control" id="source_type" ng-model="source.source_type" ng-change="sourceTypeChange()" ng-options="option as option.display_name for option in optionsSourceType" ng-disabled="source.id">
                <option value="">Select One</option>
            </select>
        </div>
    </div>
    
    <div class="row" >
        <div class="col-sm-12">
            <div ng-show="!showFields()">
                <p><b>Auction/Sale Catalog</b>: Use for auction or sale catalogs for a specific sale event. For online-only auctions (such as eBay) or sale events, use the SOURCE TYPE: Online-only Auction or Bookseller Website.</p>

                <p><b>Collection Catalog</b>: Use for published catalogs
                    of institutional or private individual collections. For individuals,
                    use SDBM PERSONAL NAME STANDARDS.</p>

                <p><b>Online-only Auction or Bookseller Website</b>: Use
                    for online-only auctions, such as eBay, or for
                    bookseller websites providing non-dated sale
                    lists. This field is intended for information found
                    only online and not referring to a specific, dated
                    sale. When the data source is an online version of a
                    print catalog (e.g. a pdf), use the SOURCE TYPE:
                    Auction/Sale Catalog.</p>

                <p><b>Personal Observation</b>: Use when recording data
                    acquired via direct personal observation of a
                    manuscript, either by yourself or someone else.</p>

                <p><b>Other Published Source</b>: Use for any other
                    published source not applicable to the previous SOURCE TYPES (e.g., an
                    inventory published in a journal article).</p>

                <p><b>Unpublished</b>: Use for any unpublished data
                    sources (e.g. in-house finding aids or inventories,
                    personal communications via email, etc). For
                    individuals, use SDBM PERSONAL NAME STANDARDS.</p>
                
                <p>Not sure what your source type is? Email us at <a href="mailto:sdbm@pobox.upenn.edu">sdbm@upenn.edu</a>.</p>
            </div>
        </div>
    </div>

    <div class="source-fields-container" ng-show="showFields()">

        <div class="form-group row" ng-show="source.source_type.name != 'online' && source.source_type.name != 'unpublished'">
            <label for="source_date" class="col-sm-2 control-label"><span sdbm-tooltip="source_date">Source Date</span></label>
            <div class="col-sm-3">
                <input type="text" class="form-control" placeholder="YYYY-MM-DD" name="source_date" id="source_date" ng-model="source.date" ng-pattern="/(^[0-9]{4}$)|(^[0-9]{4}-[0-9]{2}$)|(^[0-9]{4}-[0-9]{2}-[0-9]{2}$)/" />
            </div>
            <div class="col-sm-7" ng-show="form.source_date.$error.pattern">
                <span style="color: PaleVioletRed;">Date must be YYYY-MM-DD, YYYY-MM or YYYY</span>
            </div>
        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'auction_catalog'">

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label"><span sdbm-tooltip="source_publication_title">Publication Title</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title" required />
                </div>
            </div>

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label"><span sdbm-tooltip="source_selling_agent">Selling Agent</span></label>
                <div class="col-sm-6">
                    <!--<input id="selling_agent" class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.selling_agent.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>-->

                    <a ng-show='source.selling_agent.agent.id == undefined' class="btn btn-add-name" ng-click="selectNameAuthorityModal('names', source, 'selling_agent', 'is_provenance_agent')">Find in Name Authority</a>
                    <div ng-if='source.selling_agent.agent != undefined && source.selling_agent.agent.id != undefined' class="well well-sm well-name-authority">
                        <a class="glyphicon glyphicon-remove" ng-click="removeNameAuthority(source.selling_agent, 'agent')"></a>
                        {{ source.selling_agent.agent.name }}
                    </div>

                </div>
            </div>

            <!-- I added this to support catalogs whose entire contents are the sale of a single person; but per 10/30 meeting, Lynn says we don't need this -->
            <!--
            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label">Seller</label>
                <div class="col-sm-6">
                </div>
            </div>
            -->

        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'online'">
            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label"><span sdbm-tooltip="source_website_name">Website Name</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title" required />
                </div>
            </div>

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label"><span sdbm-tooltip="source_selling_agent">Selling Agent</span></label>
                <div class="col-sm-6">
                    <!--<input id="selling_agent" class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.selling_agent.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>-->

                    <a ng-show='source.selling_agent.agent.id == undefined' class="btn btn-add-name" ng-click="selectNameAuthorityModal('names', source, 'selling_agent', 'is_provenance_agent')">Find in Name Authority</a>
                    <div ng-if='source.selling_agent.agent != undefined && source.selling_agent.agent.id != undefined' class="well well-sm well-name-authority">
                        <a class="glyphicon glyphicon-remove" ng-click="removeNameAuthority(source.selling_agent, 'agent')"></a>
                        {{ source.selling_agent.agent.name }}
                    </div>

                </div>
            </div>
        </div>
        
        <div class="auction-source-container" ng-show="source.source_type.name == 'collection_catalog'">

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label"><span sdbm-tooltip="source_institution">Institution/Collection</span></label>
                <div class="col-sm-6">
                    <!--<input id="institution" class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.institution.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>-->

                    <a ng-show='source.institution.agent.id == undefined' class="btn btn-add-name" ng-click="selectNameAuthorityModal('names', source, 'institution', 'is_provenance_agent')">Find in Name Authority</a>
                    <div ng-if='source.institution.agent != undefined && source.institution.agent.id != undefined' class="well well-sm well-name-authority">
                        <a class="glyphicon glyphicon-remove" ng-click="removeNameAuthority(source.institution, 'agent')"></a>
                        {{ source.institution.agent.name }}
                    </div>

                </div>
            </div>

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label"><span sdbm-tooltip="source_publication_title">Publication Title</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="source_publication_author">Publication Author</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'observation'">

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label"><span sdbm-tooltip="source_source_name">Source Name</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="source_observer">Observer</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>
        
        <div class="other-published-container" ng-show="source.source_type.name == 'other_published'">

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label"><span sdbm-tooltip="source_publication_title">Publication Title</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="source_publication_author">Publication Author</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'unpublished'">

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label"><span sdbm-tooltip="source_institution">Institution/Collection</label>
                <div class="col-sm-6">
                    <!--<input class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.institution.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>-->

                    <a ng-show='source.institution.agent.id == undefined' class="btn btn-add-name" ng-click="selectNameAuthorityModal('names', source, 'institution', 'is_provenance_agent')">Find in Name Authority</a>
                    <div ng-if='source.institution.agent != undefined && source.institution.agent.id != undefined' class="well well-sm well-name-authority">
                        <a class="glyphicon glyphicon-remove" ng-click="removeNameAuthority(source.institution, 'agent')"></a>
                        {{ source.institution.agent.name }}
                    </div>
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label"><span sdbm-tooltip="source_source_name">Source Name</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="source_author_creator">Author/Creator</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>

<!--        <div class="form-group row">
            <label for="whether_mss" class="col-sm-2 control-label"><span sdbm-tooltip="source_has_manuscripts">Has Manuscripts</span></label>
            <div class="col-sm-3">
                <select class="form-control" name="whether_mss" id="whether_mss" ng-model="source.whether_mss">
                    <%= options_for_select(Source::HAS_MANUSCRIPT_TYPES) %>
                </select>
            </div>-->

        <div class="form-group row" ng-show="source.id">
            <label for="status" class="col-sm-2 control-label"><span sdbm-tooltip="source_status">Status</span></label>
            <div class="col-sm-3">
                <select class="form-control" name="status" id="status" ng-model="source.status" >
                    <%= options_for_select(Source::STATUS_TYPES) %>
			    </select>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12 text-center">
                <legend>Where did you see this source?</legend>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <p>Complete as many fields as possible. This data gives other users the ability to consult your source and provides an audit trail to ensure quality of data entry.</p>
            </div>
        </div>

        <div class="form-group row">
            <label for="location" class="col-sm-2 control-label"><span sdbm-tooltip="source_location_type">Location Type</span></label>
            <div class="col-sm-3">
                <select class="form-control" id="medium" ng-model="source.medium" ng-options="option[0] as option[1] for option in optionsMedium" ng-disabled="source.source_type.name == 'online'">
                    <option value="">Select One</option>
                </select>
            </div>
        </div>

        <div class="form-group row">
            <label for="city" class="col-sm-2 control-label"><span sdbm-tooltip="source_date_accessed">Date Accessed</span></label>
            <div class="col-sm-3">
                <input type="text" class="form-control" name="date_accessed" id="date_accessed" ng-model="source.date_accessed" ng-pattern="/(^[0-9]{4}$)|(^[0-9]{4}-[0-9]{2}$)|(^[0-9]{4}-[0-9]{2}-[0-9]{2}$)/"/>
            </div>
            <div class="col-sm-7" ng-show="form.date_accessed.$error.pattern">
                <span style="color: PaleVioletRed;">Date must be YYYY-MM-DD, YYYY-MM or YYYY</span>
            </div>
        </div>

        <div class="form-group row" ng-show="source.medium != 'internet' && source.medium != 'personal_communication'">
            <label for="city" class="col-sm-2 control-label">
                <span sdbm-tooltip="source_institution_location_seen" ng-show="source.medium != 'private_collection'">Institution</span>
                <span sdbm-tooltip="source_institution_location_seen" ng-show="source.medium == 'private_collection'">Collection</span>
            </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" name="location_institution" id="location_institution" ng-model="source.location_institution" />
            </div>
        </div>

        <div class="form-group row" ng-show="source.medium != 'internet'">
            <label for="city" class="col-sm-2 control-label"><span sdbm-tooltip="source_location_seen">Location (City, Country)</span></label>
            <div class="col-sm-6">
                <input type="text" class="form-control" name="location" id="location" ng-model="source.location" />
            </div>
        </div>
                
        <div class="form-group row" ng-show="source.source_type.name != 'observation'">
            <label for="location" class="col-sm-2 control-label"><span sdbm-tooltip="source_link">Online Link / Call Num.</span></label>
            <div class="col-sm-9">
                <input type="text" class="form-control" name="link" id="link" ng-model="source.link" />
            </div>
        </div>
        
         <div class="row">
            <div class="col-sm-12 text-center">
                <legend>Comments</legend>
            </div>
        </div>

        <div class="form-group row">
            <label for="editorial_comments" class="col-sm-2 control-label">
                <span sdbm-tooltip="source_comments">Comments</span>
            </label>
            <div class="col-sm-9">
                <textarea class="form-control" id="comments" data-ng-model="source.comments"></textarea>
            </div>
        </div>


        <div class="row">
          <div class="col-sm-2"></div>
          <div class="col-sm-10">
            <button class="btn btn-primary" ng-click="save()" ng-disabled="form.$invalid || currentlySaving">Save</button>
            <a class="btn btn-warning" href="<%= new_entry_path %>">Cancel</a>
            <div ng-show="currentlySaving" style="display: inline;">
                <img id="spinner" alt="working..." src="<%= asset_path "spinner.gif" %>" style="margin-left: 10px; margin-right: 10px;"/> Working, please wait...
            </div>
          </div>
        </div>
    </div>


    <% if Rails.env.development? %>
        <br/><br/>
        <br/><br/>
        <a href="#" data-ng-click="debug()">DEBUG: Print model to console</a>
    <% end %>

</form>

<script type="text/ng-template" id="similarSources.html">
    <div class="modal-header">
        <h3 class="modal-title">Warning: similar sources found!</h3>
    </div>
    <div class="modal-body form-horizontal">

        <p>There already exist sources in the database similar to the
        one you are trying to create. Click an existing source below
        to use it, or confirm that you really want to create your
        source.</p>

        <p style="margin-left: 2em;">
            <div ng-repeat="source in similarSources"><a ng-click="sdbmutil.redirectToEntryCreatePage(source.id)" href="#">SDBM_SOURCE_{{ source.id }} - {{ source.display_value }}</a></div>
        </p>

        <button class="btn btn-primary" ng-click="confirmCreate()">Create my new source anyway</button>
        <button class="btn btn-warning" ng-click="cancelCreate()">Cancel</button>

    </div>
</script>

<script type="text/ng-template" id="postSourceSave.html">
    <div class="modal-header">
        <h3 class="modal-title">Successfully saved Source record</h3>
    </div>
    <div class="modal-body form-horizontal">
        <% if Rails.configuration.sdbmss_show_testing_message %>
            <p style="color: red">
                Please remember that this system is in development;
                the data you enter and changes you make will NOT be
                retained after the test period.
            </p>
        <% end %>

        <p>What do you want to do now?</p>

        <p style="margin-left: 2em;">

            <a ng-click="sdbmutil.redirectToEntryCreatePage(source.id)" href="#">Add entries for this source</a><br/><br/>

            <a ng-click="sdbmutil.redirectToSourceEditPage(source.id)" href="#">Return to editing this source</a><br/><br/>
            
            <a href="/dashboard">Return to my dashboard</a>

        </p>

    </div>
</script>

<%= render "shared/create_entity_with_name" %>
<%= render "shared/create_name" %>
<%= render "shared/select_name_authority" %>