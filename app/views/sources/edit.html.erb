<% content_for :head do %>
<%= stylesheet_link_tag "extras", media: "all" %>
<%= javascript_include_tag "extras" %>
<% end %>

<% if @source.persisted? %>
<input type="hidden" id="source_id" value="<%= @source.id %>" />
<% end %>
<% if !params[:create_entry].nil? %>
<input type="hidden" id="create_entry" value="1" />
<% end %>

<form name="form" class="form-horizontal sdbmss-form" ng-controller="SourceCtrl" novalidate >

    <div class="row">
        <div class="col-sm-12">
            <legend>{{ pageTitle }}</legend>
        </div>
    </div>

    <div class="form-group row">
        <label for="source_type" class="col-sm-2 control-label">Source Type</label>
        <div class="col-sm-3">
            <select class="form-control" id="source_type" ng-model="source.source_type" ng-options="option as option.display_name for option in optionsSourceType" ng-disabled="source.id">
                <option value="">Select One</option>
            </select>
        </div>
    </div>
    
    <div class="source-fields-container" ng-show="showFields()">

        <div class="form-group row" ng-show="source.source_type.name != 'online' && source.source_type.name != 'unpublished'">
            <label for="source_date" class="col-sm-2 control-label"><span sdbm-tooltip="source_date">Source Date</span></label>
            <div class="col-sm-3">
                <input type="text" class="form-control" placeholder="YYYY-MM-DD" name="source_date" id="source_date" ng-model="source.date" ng-pattern="/(^[0-9]{4}$)|(^[0-9]{4}-[0-9]{2}$)|(^[0-9]{4}-[0-9]{2}-[0-9]{2}$)/" />
            </div>
            <div class="col-sm-7" ng-show="form.source_date.$error.pattern">
                <span style="color: PaleVioletRed;">Date must be YYYY-MM-DD, YYYY-MM or YYYY</span>
            </div>
        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'auction_catalog'">

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label">Publication Title</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title" required />
                </div>
            </div>

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label">Selling Agent</label>
                <div class="col-sm-6">
                    <input id="selling_agent" class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.selling_agent.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>
                </div>
            </div>

            <!-- I added this to support catalogs whose entire contents are the sale of a single person; but per 10/30 meeting, Lynn says we don't need this -->
            <!--
            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label">Seller</label>
                <div class="col-sm-6">
                </div>
            </div>
            -->

        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'online'">
            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label">Website Name</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title" required />
                </div>
            </div>

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label">Selling Agent</label>
                <div class="col-sm-6">
                    <input id="selling_agent" class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.selling_agent.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>
                </div>
            </div>
        </div>
        
        <div class="auction-source-container" ng-show="source.source_type.name == 'collection_catalog'">

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label">Institution/Collection</label>
                <div class="col-sm-6">
                    <input class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.institution.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label">Publication Title</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="cat_author">Publication Author</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'observation'">

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label">Source Name</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="cat_author">Observer</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>
        
        <div class="other-published-container" ng-show="source.source_type.name == 'other_published'">

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label">Publication Title</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="cat_author">Publication Author</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>

        <div class="auction-source-container" ng-show="source.source_type.name == 'unpublished'">

            <div class="form-group row">
                <label for="institution" class="col-sm-2 control-label">Institution/Collection</label>
                <div class="col-sm-6">
                    <input class="form-control" type="text" sdbm-autocomplete="/names/search.json" sdbm-autocomplete-params='{ "type": "is_provenance_agent" }' sdbm-autocomplete-model="source.institution.agent" sdbm-autocomplete-modal-controller="CreateNameModalCtrl" sdbm-autocomplete-modal-template="createName.html"/>
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_title" class="col-sm-2 control-label">Source Name</label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="title" ng-model="source.title">
                </div>
            </div>

            <div class="form-group row">
                <label for="cat_author" class="col-sm-2 control-label"><span sdbm-tooltip="cat_author">Author/Creator</span></label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="author" ng-model="source.author">
                </div>
            </div>

        </div>

        <div class="form-group row">
            <label for="whether_mss" class="col-sm-2 control-label"><span sdbm-tooltip="source_date">Has Manuscripts</span></label>
            <div class="col-sm-3">
                <select class="form-control" name="whether_mss" id="whether_mss" ng-model="source.whether_mss">
                    <%= options_for_select(Source::HAS_MANUSCRIPT_TYPES) %>
                </select>
            </div>
        </div>

        <!-- TODO: add this back in, but only show it when editing a source, not when creating one -->
        <!--
        <div class="form-group row">
            <label for="status" class="col-sm-2 control-label"><span sdbm-tooltip="source_date">Status</span></label>
            <div class="col-sm-3">
                <select class="form-control" name="status" id="status" ng-model="source.status" >
                    <%= options_for_select(Source::STATUS_TYPES) %>
			    </select>
            </div>
        </div>
        -->

        <div class="row">
            <div class="col-sm-12">
                <legend>Where did you see this source?</legend>
            </div>
        </div>

        <div class="form-group row">
            <label for="location" class="col-sm-2 control-label"><span sdbm-tooltip="source_medium"></span></label>
            <div class="col-sm-3">
                <select class="form-control" id="medium" ng-model="source.medium" ng-options="option[0] as option[1] for option in optionsMedium">
                    <option value="">Select One</option>
                </select>
            </div>
        </div>

        <div class="form-group row">
            <label for="city" class="col-sm-2 control-label"><span sdbm-tooltip="source_date_accessed">Date Accessed</span></label>
            <div class="col-sm-3">
                <input type="text" class="form-control" name="date_accessed" id="date_accessed" ng-model="source.date_accessed" />
            </div>
        </div>

        <div class="form-group row" ng-show="source.medium != 'internet' && source.medium != 'personal_communication'">
            <label for="city" class="col-sm-2 control-label">
                <span sdbm-tooltip="source_institution" ng-show="source.medium != 'private_collection'">Institution</span>
                <span sdbm-tooltip="source_institution" ng-show="source.medium == 'private_collection'">Collection</span>
            </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" name="location_institution" id="location_institution" ng-model="source.location_institution" />
            </div>
        </div>

        <div class="form-group row" ng-show="source.medium != 'internet'">
            <label for="city" class="col-sm-2 control-label"><span sdbm-tooltip="source_location">Location (City, Country)</span></label>
            <div class="col-sm-6">
                <input type="text" class="form-control" name="location" id="location" ng-model="source.location" />
            </div>
        </div>
                
        <div class="form-group row" ng-show="source.source_type.name != 'observation'">
            <label for="location" class="col-sm-2 control-label"><span sdbm-tooltip="source_link">Online Link / Call Num.</span></label>
            <div class="col-sm-9">
                <input type="text" class="form-control" name="link" id="link" ng-model="source.link" />
            </div>
        </div>
        
         <div class="row">
            <div class="col-sm-12">
                <legend>Comments</legend>
            </div>
        </div>

        <div class="form-group row">
            <label for="editorial_comments" class="col-sm-2 control-label">
                <span sdbm-tooltip="entry">Comments</span>
            </label>
            <div class="col-sm-9">
                <textarea class="form-control" id="comments" data-ng-model="source.comments"></textarea>
            </div>
        </div>


        <div class="row">
          <div class="col-sm-2"></div>
          <div class="col-sm-10">
            <button class="btn btn-primary" ng-click="save()" ng-disabled="form.$invalid || currentlySaving">Save</button>
            <a class="btn btn-warning" href="<%= new_entry_path %>">Cancel</a>
          </div>
        </div>

    </div>

    <br/><br/>
  <br/><br/>
  <a href="#" data-ng-click="debug()">DEBUG: Print model to console</a>

</form>

<script type="text/ng-template" id="postSourceSave.html">
    <div class="modal-header">
        <h3 class="modal-title">Successfully saved Source record</h3>
    </div>
    <div class="modal-body form-horizontal">
        
        <p>What do you want to do now?</p>

        <p style="margin-left: 2em;">

            <a ng-click="sdbmutil.redirectToEntryCreatePage(source.id)" href="#">Add entries for this source</a><br/><br/>

            <a ng-click="sdbmutil.redirectToSourceEditPage(source.id)" href="#">Return to editing this source</a><br/><br/>
            
            <a href="/dashboard">Return to my dashboard</a>

        </p>

    </div>
</script>

<%= render "shared/create_entity_with_name" %>
<%= render "shared/create_name" %>
