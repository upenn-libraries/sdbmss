<div class='panel panel-primary'>
    <div class='panel-heading'>
        <h3 class='h3'>Merge <%= @source.public_id %> &#10132; <%= @target.present? ? @target.public_id : "???" %></h3>
    </div>
</div>

<div class="row">
    <div class="col-sm-5">
        <div class='panel <%= @target.present? ? "panel-danger" : "panel-default" %>'>
            <div class='panel-heading'>
                <div class='h4'><%= link_to @source.public_id, source_path(@source) %> <%= @target.present? ? "(Will be deleted)" : "" %>
                    <small class="pull-right badge"><%= @source.entries_count %> entries</small>
                </div>
            </div>
            <% if @target.present? %>
                <div class="panel-body"><%= render partial: "sources/edit", locals: { source: @source, index: 0 } %></div>
            <% else %>
                <div class="panel-body"><%= render partial: "sources/source_details", locals: {source: @source} %></div>
            <% end %>
        </div>
    </div>
    <div class='col-sm-2'>
        <%= image_tag 'right-arrow.png', class: 'img img-responsive' %>
    </div>
    <!-- form tag for collecting the results of the merge request -->
    <%= form_tag(request.path, method: :post, class: "form-horizontal sdbmss-form") do %>
    <div class="col-sm-5">
        <% if @target_id.present? && @target.present? %>
            <div class='panel <%= @target.present? ? "panel-success" : "panel-default" %>'>
                <div class='panel-heading'>
                    <div class='h4'><%= link_to @target.public_id, source_path(@target) %>
                        <small class="pull-right badge"><%= @target.entries_count %> entries</small>
                    </div>
                </div>
                <div class="panel-body"><%= render partial: "sources/edit", locals: { source: @target, index: 1 } %></div>
            </div>
        <% else %>
            <% if @target_id.present? %>
                <div class='panel panel-danger'>
                <% if @warning.present? %>
                    <div class="panel-heading"><%= @warning %></div>
                <% else %>
                    <div class="panel-heading">Could not find record #<%= @target_id %></div>
                <% end %>
                </div>
            <% end %>
            <%= form_tag(request.path, method: :get, class: "form-horizontal sdbmss-form") do %>
                <div class="row">
                    <label class="col-sm-3 control-label">Find by unique ID</label>
                    <div class="col-sm-6">
                        <input type="text" name="target_id" class="form-control"></p>
                    </div>
                    <div class="col-sm-3">
                        <button class="btn btn-primary">Select</button>
                    </div>
                </div>
            <% end %>
            <div class='panel panel-default'>
                <% if @similar.present? %>
                    <div class='panel-heading'><b>Suggestions</b></div>
                    <table class='table table-striped'>
                      <thead>
                        <tr>
                            <th></th>
                            <th>ID</th>
                            <th>Source Agent</th>
                            <th>Date</th>
                            <th>Entries</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% @similar.each do |src| %>
                            <% if src.id != @source.id %>
                            <tr>
                                <td><a class='btn btn-primary' href="<%= source_path(id: @source.id)%>/merge?target_id=<%= src.id %>">Select</a></td>
                                <td><%= link_to src.id, source_path(src.id) %></td>
                                <td><%= src.source_agents[0].agent.name if src.source_agents.count > 0 %></td>
                                <td><%= format_fuzzy_date(src.date) %></td>
                                <td><a href="<%= search_advanced_path(source: src.public_id) %>"><%= src.entries.approved_only.count %> entries</a></td>
                            </tr>
                            <% end %>
                        <% end %>
                      </tbody>
                    </table>
                <% else %>
                    <b>No suggested names found, use manual search above.</b>
                <% end %>
            </div>
        <% end %>
    </div>

    <% if @target.present? %>
    <div class="col-sm-6"></div>
    <div class="col-sm-6">
        <input type="hidden" name="confirm" value="yes"/>
        <input type="hidden" name="target_id" value="<%= @target.id %>"/>
        <div><b>Confirm</b></div>
        <p>Are you sure you want to do this? <%= @source.public_id %> will be marked as deleted and its fields cleared out.</p>
        <button class="btn btn-primary">Yes</button>
        <a class="btn btn-warning" href="<%= merge_source_path(@source) %>">Cancel</a>
        <%= link_to "Swap", merge_source_path(@target, :target_id => @source.id), class: 'btn btn-info' %>
    </div>

<% end %>

<% end %>
