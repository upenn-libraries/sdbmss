<h1>History of changes to <%= @entry.public_id %></h1>

<% changesets = ModelHistory.new(@entry).changesets %>
<% legacy = EntryChange.where(entry_id: @entry.id).order(change_date: :desc) %>
<% if changesets.count > 0 || legacy.count > 0 %>
<table class="table">
    <thead>
        <tr>
            <th width="15%">Date</th>
            <th width="15%">User</th>
            <th width="20%">Action</th>
            <th width="25%">Details</th>
            <th width="15%"></th>
            <th width="10%"></th>
        </tr>
    </thead>
    <tbody>
        <% changesets.each do |changeset| %>
        <tr>
            <td><%= changeset.date.to_formatted_s(:date_and_time) %></td>
            <td><%= changeset.user %></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <% changeset.versions.each do |version| %>
            <% formatter = EntryVersionFormatter.new(version) %>
                <% if formatter.details.count > 0 %>
                    <tr>
                        <td></td>
                        <td></td>
                        <td><%= formatter.action %></td>
                        <td colspan="2">
                            <% formatter.details.each do |detail| %>
                                <%= detail %></br>
                            <% end %>
                        </td>
                        <td>
                            <%= link_to "Undo", revert_entry_path(@entry, version_id: version.id), class: 'btn btn-default btn-block' %>
                        </td>
                    </tr>
            <% end %>
            <% end %>
        <% end %>

        <% legacy.each do |entry_change| %>
        <tr>
            <td><%= entry_change.change_date.to_formatted_s(:date_and_time) %></td>
            <td><%= entry_change.changed_by.username %></td>
            <td><%= entry_change.change_type %> <%= entry_change.column %></td>
            <td><%= entry_change.changed_from %></td>
            <td><%= entry_change.changed_to %></td>
        </tr>
        <% end %>
    </tbody>
</table>
<% else %>
<p>There is no history to display for this entry.</p>
<% end %>
