<% content_for :head do %>
<%= stylesheet_link_tag "extras", media: "all" %>
<%= javascript_include_tag "extras" %>
<script type="text/javascript">

$(document).ready(function() {

    var resourceName = "<%= resource_name %>";

    // flag = show all records, or only those that the user created
    <% if can? :manage, model_class  %>
    var createdByUser = 0;
    <% else %>
    var createdByUser = 1;
    <% end %>
    
    SDBM.hideNavBar();

    var getSearchValue = function() {
        return $("input[name='search_value']").val();
    };

    var getUnreviewedOnly = function() {
        return $("input[name='unreviewed_only']").is(':checked') ? 1 : 0;
    };
    
    var setFormStateFromURL = function() {
        var qs = new URI().query(true);
        $("input[name='search_value']").val(qs.term);
        if(qs.unreviewed_only === 1) {
            $("input[name='unreviewed_only']").prop('checked', true);
        }
    };

    window.onpopstate = function(event) {
        // load the data from URL into page
        setFormStateFromURL();
        dataTable.reload();
    };

    setFormStateFromURL();
    
    var columns = [
        {
            title: 'Options',
            orderable: false,
            render: function (data, type, full, meta) {
                var str = '<a href="/' + resourceName + '/' + data + '/edit/">Edit</a> '
                        + '&middot; <a class="delete-link" href="/' + resourceName + '/' + data + '.json">Delete</a>';
                return str;
            },
            width: "10%"
        },
        {
            title: 'ID',
            dbSortField: 'id'
        },
        {
            title: 'Name',
            width: "70%",
            dbSortField: '<%= search_name_field %>'
        },
        {
            title: 'Count',
            width: "20%",
            dbSortField: 'entries_count'
        },
        {
            title: 'Reviewed',
            width: "20%",
            dbSortField: 'reviewed'
        },
        {
            title: 'Created By',
            width: "20%",
            dbSortField: 'created_by_id'
        }
    ];
    
    var dataTable = new SDBM.Table(".sdbm-table", {
        ajax: function (sdbmTable, dt_params, callback, settings) {

            var orderStr = "";
            dt_params.order.forEach(function(item) {
                orderStr += columns[item.column].dbSortField + " " + item.dir;
            });
                
            var params = {
                term: getSearchValue(),
                unreviewed_only: getUnreviewedOnly(),
                created_by_user: createdByUser,
                offset: dt_params.start,
                limit: dt_params.length,
                order: orderStr
            };

            $.ajax({
                url: '/' + resourceName + '/search.json',
                data: params,
                success: function(data, textStatus, jqXHR) {
                    if(!data.error) {
                        $(".dataTables_scrollBody").scrollTop(0);
                        var rows = [];
                        data.results.forEach(function(item) {
                            rows.push([ item.id, item.id, item.<%= search_name_field %>, item.entries_count || 0, item.reviewed, item.created_by || "" ]);
                        });
                        callback({
                            draw: dt_params.draw,
                            data: rows,
                            recordsTotal: data.total,
                            recordsFiltered: data.total,
                        });
                    } else {
                        alert("An error occurred fetching search results: " + data.error);
                    }
                },
                error: function() {
                    // TODO: fill this out
                    alert("An error occurred fetching search results");
                }
            });
        },
        columns: columns,
        order: [[ 2, "asc" ]]
    });

    $(".sdbm-table").on("click", ".delete-link", function(event) {
        if(confirm("Are you sure you want to delete this record?")) {
            $.ajax({
                url: $(event.target).attr("href"),
                method: 'DELETE',
                success: function(data, textStatus, jqXHR) {
                    dataTable.reload();                    
                },
            });
        }
        return false;
    });
    
    $('#search_submit').click(function() {
        var url = URI('/' + resourceName + '/').search({ term: getSearchValue(), unreviewed_only: getUnreviewedOnly() });

        history.pushState({ url: url }, '', url);

        dataTable.reload();
        return false;
    });

    $('#export-csv').click(function() {
        var qs = new URI().query(true);

        var url = URI('/' + resourceName + '/search.csv').search({ term: getSearchValue(), unreviewed_only: getUnreviewedOnly() });

        window.location = url;
        return false;
    });

 });
</script>
<% end %>

<% if !can? :manage, model_class %> 
    <h1>Manage <%= resource_name %> records you've created</h1>
<% else %>
    <h1>Manage all <%= resource_name %> records</h1>
<% end %>

<%= form_tag(request.path, method: :get, class: "form-horizontal search-form") do %>
    <div class="row form-group search-fieldset original">
        <div class="col-sm-1">
            <label class="control-label">Search</label>
        </div>
        <div class="col-sm-4">
            <%= text_field_tag :search_value, params[:search_value], sizze: 70, class: "form-control" %>
        </div>
        <div class="col-sm-3 checkbox">
        <% if can? :manage, model_class  %>
            <label>
                <%= check_box_tag :unreviewed_only, 1, params[:unreviewed_only] %> Limit to records needing review
            </label>
        <% end %>
        </div>
        <div class="col-sm-1">
            <input id="search_submit" type="submit" class="btn btn-primary" name="submit" value="Search">
        </div>
        <div class="col-sm-2 col-sm-offset-1 text-right">
            <a class="btn btn-primary" href="<%= new_model_path %>">Add New Record</a>
        </div>
    </div>
<% end %>

<table id="search_results" class="sdbm-table table dataTable table-striped table-bordered nowrap compact" width="100%" cellspacing="0">
    <thead>
        <tr>
        </tr>
    </thead>
</table>

<div style="text-align: right">
    <a id="export-csv" href="#">Export search results as csv</a>
</div>
