<% content_for :head do %>
<%= stylesheet_link_tag "extras", media: "all" %>
<%= javascript_include_tag "extras" %>

<style>

.navbar { margin-bottom: 10px; }

#main-container.container-fluid .row { padding-left: 15px; padding-right: 15px; }

.search-fieldset { margin-bottom: 8px; }

</style>
<script type="text/javascript">

$(document).ready(function() {

    // TODO: hacks to tweak the Rails layout: figure out a more elegant way?
    $("#search-navbar").remove();
    // make this page take up full width of browser window
    $("#main-container").removeClass("container").addClass("container-fluid");

    var mode = '<%= @mode %>';
    var entryId;
    var manuscriptId;    
    var entryManuscripts;
    var headingId = '<%= @mode == 'by_entry' ? @entry.public_id : @manuscript.public_id %>';
    
    <% if @mode == 'by_entry' %>
    entryId = <%= @entry.id %>;
    entryManuscripts = [
        {
            entry_id: entryId,
            relation_type: 'is'
        }
    ];
    <% else %>
    manuscriptId = <%= @manuscript.id %>;
    entryManuscripts = <%= JSON.generate(@manuscript.entry_manuscripts.map { |entry_manuscript|
                                                                            {
                                                                             id: entry_manuscript.id,
                                                                             entry_id: entry_manuscript.entry_id,
                                                                             manuscript_id: entry_manuscript.manuscript_id,
                                                                             relation_type: entry_manuscript.relation_type
                                                                             }
                                                                            }).html_safe %>;
    <% end %>

    var getActiveEntryManuscripts = function() {
        return entryManuscripts.filter(function (entry_manuscript) {
            return !entry_manuscript._destroy;
        });
    };
    
    var changeWorkspaceEntry = function (entryId, relation) {
        if(relation != 'unlink') {
            var idAlreadyExists = false;
            $.each(entryManuscripts, function (idx, workspaceEntry) {
                if(workspaceEntry.entry_id == entryId) {
                    workspaceEntry.relation_type = relation;
                    idAlreadyExists = true;
                }
            });
            if (!idAlreadyExists) {
                entryManuscripts.push({
                    entry_id: entryId,
                    relation_type: relation
                });
            }
        } else {
            deleteWorkspaceEntry(entryId);            
        }
    };

    var deleteWorkspaceEntry = function(entryId) {
        var idxToDelete = -1;
        $.each(entryManuscripts, function (idx, workspaceEntry) {
            if(workspaceEntry.entry_id == entryId) {
                idxToDelete = idx;
            }
        });
        if (idxToDelete != -1) {
            if(entryManuscripts[idxToDelete].id) {
                entryManuscripts[idxToDelete]._destroy = 1;
            } else {
                entryManuscripts.splice(idxToDelete, 1);
            }
        }
    };

    var isInWorkspace = function(entryId, relationType) {
        var inWorkspace = false;
        $.each(entryManuscripts, function (idx, workspaceEntry) {
            if(workspaceEntry.entry_id == entryId && workspaceEntry.relation_type == relationType) {
                inWorkspace = true;
            }
        });
        return inWorkspace;
    };
    
    var potentialMatches = null;

    var getRadioButtonHTML = function(sdbmTable, data, value) {
        var entryId = data[sdbmTable.getColumnIndex("ID")];
        var checked = isInWorkspace(entryId, value) ? "checked='checked'" : "";
        return '<input type="radio" class="toggle-entry-link" data-entry-id="' + entryId + '" name="entry_id_' + entryId + '" value="' + value + '" ' + checked + '/>';
    };

    // Fielded search specific params
    var translateSearchParams = function (sdbmTable, data) {
        params = sdbmTable.translateParamsToBlacklight(data);

        if(potentialMatches == null) {
            params["op"] = $("select[name='op']").val();

            $("select[name='search_field']").each(function (idx, element) {
                var search_field = $(element).val();
                var search_value = $($("input[name='search_value']")[idx]).val();
                if(search_value) {
                    params[search_field] = search_value;
                }
            });
        } else {
            console.log("Doing Potential Match search");
            params["entry_id"] = potentialMatches.join(" OR ");
        }
        
        return params;
    };

    var workspaceTable = new SDBM.EntryTable("#workspace", {
        dom: '<"clear">JRt',
        height: '135px',
        fixedColumns: 5,
        prependColumns: [
            {
                sdbmssMinWidth: "50px",
                title: 'Link',
                "data": null,
                "orderable": false,
                "className": 'text-center',
                "render": function (data, type, full, meta) {
                    return getRadioButtonHTML(workspaceTable, data, "is");
                }
            },
            {
                sdbmssMinWidth: "60px",
                title: 'Fragment',
                "data": null,
                "orderable": false,
                "className": 'text-center',
                "render": function (data, type, full, meta) {
                    return getRadioButtonHTML(workspaceTable, data, "partial");
                }
            },
            {
                sdbmssMinWidth: "60px",
                title: 'Possible',
                "data": null,
                "orderable": false,
                "className": 'text-center',
                "render": function (data, type, full, meta) {
                    return getRadioButtonHTML(workspaceTable, data, "possible");
                }
            },
            {
                sdbmssMinWidth: "50px",
                title: 'Unlink',
                "data": null,
                "orderable": false,
                "className": 'text-center',
                "render": function (data, type, full, meta) {
                    return getRadioButtonHTML(workspaceTable, data, "unlink");
                }
            }
        ],
        ajax: function (sdbmTable, dt_params, callback, settings) {
            $("#spinner").show();

            var params = sdbmTable.translateParamsToBlacklight(dt_params);

            params.entry_id = $.map(getActiveEntryManuscripts(), function(item) { return item.entry_id; }).join(" OR ");

            sdbmTable.searchAndUpdateTable(params, callback, {
                'complete': function () {
                    $("#spinner").hide();
                }
            });
        }
    });

    var resultsTable = new SDBM.EntryTable("#search_results", {
        dom: '<"clear"><"H"r>JRt<"F"ip>',
        height: function() {
            // height gets passed into dataTables constructor before
            // it's had a chance to construct all its crazy DOM bits,
            // so it's hard to calculate height dynamically to fit the
            // viewport. This seems pretty decent.
            var footer_size = 100;
            return $(window).height() - $("#search_results").offset().top - footer_size;
        },
        fixedColumns: 2,
        prependColumns: [
            {
                sdbmssMinWidth: "255px",
                title: 'Options',
                "data": null,
                "orderable": false,
                "render": function (data, type, full, meta) {
                    var entryId = data[resultsTable.getColumnIndex("ID")];
                    var manuscriptId = data[resultsTable.getColumnIndex("Manuscript")];
                    if(mode == 'by_entry') {
                        if(manuscriptId) {
                            return '<a href="#" data-manuscript-id="' + manuscriptId + '" class="link-to-manuscript-link">Link to SDBM_MS_' + manuscriptId + '</a>';
                        } else {
                            return '<a href="#" data-entry-id="' + entryId + '" class="add-entry-link">Add to queue</a>';
                        }
                    } else {
                        if(!manuscriptId) {
                            return '<a href="#" data-entry-id="' + entryId + '" class="add-entry-link">Add this entry to manuscript</a>';
                        }
                    }
                    return "";
                }
            }
        ],
        ajax: function (sdbmTable, dt_params, callback, settings) {
            $("#spinner").show();

            // seems like there should be a way to do this conditional
            // ajax and subsequent searchAndUpdateTable using
            // promises, but I can't figure that out right now
            
            var params = translateSearchParams(sdbmTable, dt_params);                
            sdbmTable.searchAndUpdateTable(params, callback, {
                'complete': function () {
                    $("#spinner").hide();
                }
            });
        }
    });

    var doSearch = function() {
        potentialMatches = null;
        resultsTable.reload();
    };
    
    $('#search_results tbody').on('click', 'tr', function (event) {
        // don't select if a link inside table was clicked
        if(event.target.tagName !== 'A') {
            $(event.currentTarget).toggleClass('selected');
        }
    });
    
    $('#search_submit').click(function() {
        doSearch();
    });

    $(document).on("click", ".add-entry-link", function (event) {
        var entryId = $(event.target).data("entryId");
        changeWorkspaceEntry(entryId, "is");
        workspaceTable.reload();
        return false;
    });

    $(document).on("click", ".toggle-entry-link", function (event) {
        var entryId = $(event.target).data("entryId");
        var value = $(event.target).val();
        changeWorkspaceEntry(entryId, value);
        workspaceTable.reload();
        return false;
    });

    $(document).on("click", ".link-to-manuscript-link", function (event) {
        var manuscriptId = $(event.target).data("manuscriptId");

        $.ajax({
            url: "/entry_manuscripts.json",
            type: 'POST',
            contentType: "application/json",
            dataType: "json",
            data: JSON.stringify({
                entry_manuscript: {
                    manuscript_id: manuscriptId,
                    entry_id: entryId,
                    relation_type: 'is',
                }
            }),
            success: function(data, textStatus, jqXHR) {
                var title = "Successfully Linked";
                var body = '<p>Link between SDBM_' + entryId + ' and SDBM_MS_' + manuscriptId + ' successfully created.</p>' +
                           '<p><a class="manuscript-link" href="/linkingtool/manuscript/' + manuscriptId + '">Go to page for SDBM_MS_' + manuscriptId + ' now</a></p>';

                SDBM.showModal("#modal", {
                    allowDismiss: false,
                    showFooter: false,
                    title: title,
                    body: body
                });
            },
            error: function() {
                // TODO: fill this out
                alert("An error occurred creating a manuscript.");
            }
        });

        return false;
    });

    $("#persist-entries-manuscript-link").click(function (event) {
        if(mode == 'by_entry') {
            if(entryManuscripts.length > 1) {
                $.ajax({
                    url: '/manuscripts.json',
                    type: 'POST',
                    contentType: "application/json",
                    dataType: "json",
                    data: JSON.stringify({
                        entry_manuscripts: entryManuscripts
                    }),
                    success: function(data, textStatus, jqXHR) {
                        var body = "<p>Manuscript SDBM_MS_" + data.manuscript_id + " successfully created!</p><p><a href='/linkingtool/manuscript/" + data.manuscript_id + "'>Click here</a> to go to the linking tool for that manuscript now.";
                        SDBM.showModal("#modal", {
                            allowDismiss: false,
                            showFooter: false,
                            title: "Success",
                            body: body
                        });
                    },
                    error: function() {
                        // TODO: fill this out
                        alert("An error occurred creating a manuscript.");
                    }
                });
            } else {
                SDBM.showErrorModal("#modal", "Creating a Manuscript requires more than 1 entry. Queue some entries and try again.");
            }
        } else {
            $.ajax({
                contentType: 'application/json',
                url: '/entry_manuscripts/update_multiple.json',
                type: 'PUT',
                dataType: 'json',
                data: JSON.stringify({
                    manuscript_id: manuscriptId,
                    entry_manuscripts: entryManuscripts
                }),
                success: function(data, textStatus, jqXHR) {
                    alert("Your changes have been saved");
                    location.reload(true);
                },
                error: function() {
                    // TODO: fill this out
                    alert("An error occurred saving associations.");
                }
            });
        }
        return false;
    });

    $("#show-matches").click(function () {
        $("#spinner").show();

        var url, key;
        if(mode == 'by_entry') {
            url = '/entries/' + entryId + '/similar.json',
            key = 'similar';
        } else {
            url = '/manuscripts/' + manuscriptId + '/entry_candidates.json',
            key = 'entry_candidates';
        }

        $.ajax({
            url: url,
            type: 'GET',
            success: function(data, textStatus, jqXHR) {
                if(data[key] && data[key].length > 0)  {
                    potentialMatches = data[key];
                    resultsTable.reload();
                } else {
                    SDBM.showModal("#modal", {
                        title: "No matches found",
                        body: "No matches found"
                    });
                }
            },
            error: function() {
                // TODO: fill this out
                alert("An error occurred finding matches.");
            },
            complete: function() {
                $("#spinner").hide();
            }
        });
    });

    $("#show-more-search-fields-link").click(function() {
        if($("#show-more-search-fields-link").text().match(/Show/)) {
            $("#show-more-search-fields-link").text("Hide additional search fields");
            $(".more-search-fields").show();
        } else {
            $("#show-more-search-fields-link").text("Show more search fields");
            $(".more-search-fields").hide();
        }
        return false;
    });
    
    $('#workspace_wrapper .dataTables_scrollBody').on('scroll', function (event) {
        $("#search_results_wrapper .dataTables_scrollBody").scrollLeft($(event.target).scrollLeft());
    });
    $('#search_results_wrapper .dataTables_scrollBody').on('scroll', function (event) {
        $("#workspace_wrapper .dataTables_scrollBody").scrollLeft($(event.target).scrollLeft());
    });
    
    $("#linking-tool-heading-id").text(headingId);
    $("#workspace-table-title").text(
        mode == 'by_entry' ? "Entries Queued for Creating New Manuscript Record" : "Entries for " + headingId);
    $("#persist-entries-manuscript-link").text(
        mode == 'by_entry' ? "Create Manuscript" : "Save changes");
     
    // TODO: this doesn't work
    // $(window).bind('resize', function () {
    //     console.log("RESIZED!");
    //     var NewHeight = getViewportHeight() - table_height_buffer;
    //     var oSettings = table.settings();
    //     console.log(table.settings());
    // next line is wrong: figure out where scrollY is stored?
    //     oSettings.oScroll.sY = NewHeight + "px";
    //     table.fnDraw();
    // });

});

</script>
<% end %>

<div style="width: 100%;">
    <span style="font-size: 18px; font-weight: bold;">Linking Tool: <span id="linking-tool-heading-id"></span></span>
</div>

<div style="margin-bottom: 6px">
    <span style="font-size: 14px; font-weight: bold;"><span id="workspace-table-title"></span></span>
    <button id="persist-entries-manuscript-link" class="btn btn-primary btn-xs" style="margin-left: 40px"></button>
</div>

<table id="workspace" class="sdbm-table table dataTable table-striped table-bordered nowrap compact" style="width: 100%">
    <thead>
        <tr>
            <!-- we populate TH elements dynamically -->
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<div style="margin-bottom: 6px; margin-top: 15px;">
    <span style="font-size: 14px; font-weight: bold;">Search for Entries</span>
</div>

<form class="form-horizontal search-form" style="margin-top: 10px;">
        <div style="height: 28px">
            <label style="width: 60px">Search</label>
            <input name="search_value" value="" size="30" type="text">
            <select name="search_field">
            <%- search_fields_for_advanced_search.sort.each do |key, field_def| -%>
            <option value="<%= key %>"><%= field_def.label %></option>
            <%- end -%>
            </select>
            <button id="search_submit" class="btn btn-primary btn-xs">Search</button>
            <img id="spinner" alt="working..." style="display: none;" src="<%= asset_path "spinner.gif" %>"/>
            <button id="show-matches" class="btn btn-primary btn-xs" style="margin-left: 40px">Show potential matches</button>
        </div>
        <div style="display: none; height: 28px" class="more-search-fields">
            <span style="width: 60px; display: inline-block;">&nbsp;</span>
            <input name="search_value" value="" size="30" type="text">
            <select name="search_field">
            <%- search_fields_for_advanced_search.sort.each do |key, field_def| -%>
            <option value="<%= key %>"><%= field_def.label %></option>
            <%- end -%>
            </select>
        </div>
        <div style="display: none; height: 28px" class="more-search-fields">
            <span style="width: 60px; display: inline-block;">&nbsp;</span>
            <input name="search_value" value="" size="30" type="text">
            <select name="search_field">
            <%- search_fields_for_advanced_search.sort.each do |key, field_def| -%>
            <option value="<%= key %>"><%= field_def.label %></option>
            <%- end -%>
            </select>
            <div style="display: inline-block">
                Match <select style="width: 100px; display: inline" name="op"><option value="AND">all</option><option value="OR">any</option></select>
                of these fields
            </div>
        </div>
        <div>
            <a href="#" id="show-more-search-fields-link">Show more search fields</a>
        </div>
</form>

<table id="search_results" class="sdbm-table table dataTable table-striped table-bordered nowrap compact" style="width: 100%">
    <thead>
        <tr>
            <!-- we populate TH elements dynamically -->
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>
